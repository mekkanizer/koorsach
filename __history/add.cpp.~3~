//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "add.h"
#include "main.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm4 *Form4;
//---------------------------------------------------------------------------
void __fastcall TForm4::n_s_box_refresh() {
    int i, n;
	Form1->ADOQuery1->Close();
	Form1->ADOQuery1->SQL->Clear();
	Form1->ADOQuery1->SQL->Add("\
		SELECT Кол_во_мест\
		FROM Самолеты\
		INNER JOIN Рейсы ON\
		Самолеты.Номер_самолета = Рейсы.Номер_самолета\
		WHERE Номер_рейса = '" + ComboBox2->Text + "'");
	Form1->ADOQuery1->Open();
	n = Form1->ADOQuery1->Fields->Fields[0]->AsInteger;

	Form1->ADOQuery1->Active = false;
	Form1->ADOQuery1->SQL->Text = "SELECT Номер_места FROM Билеты\
	WHERE Номер_рейса = '" + ComboBox2->Text + "'";
	Form1->ADOQuery1->Active = true;
	ComboBox3->Items->Clear();
	for (i = 1; i <= n; i++)
		if (Form1->ADOQuery1->FieldByName("Номер_места")->AsInteger != i) {
			ComboBox3->Items->Add(IntToStr(i));
			if (!Form1->ADOQuery1->Eof)
				Form1->ADOQuery1->Next();
		}
	ComboBox3->Text = ComboBox3->Items->Strings[0];
}
//---------------------------------------------------------------------------
bool __fastcall TForm4::is_numeric (String data) {
	bool result = true;
	if (data.IsEmpty())
		result = false;
	else
		for (int i = 1; (i <= data.Length()) && (result); i++)
			if ((data[i] < '0') || (data[i] > '9'))
				result = false;
	return result;
}
//---------------------------------------------------------------------------
bool __fastcall TForm4::is_time (String data) {
	bool result = true;
	bool two = false;
	if ((data[1] < '0') || (data[1] > '2'))
		result = false;
	else if (data[1] == '2')
		two = true;
	if (data[2] < '0')
		result = false;
	if (two) {
		if (data[2] > '3')
			result = false;
	}
	else if (data[2] > '9')
		result = false;
	if (data[3] != ':')
		result = false;
	if ((data[4] < '0') || (data[4] > '5'))
		result = false;
	if ((data[5] < '0') || (data[5] > '9'))
		result = false;
	return result;
}

//---------------------------------------------------------------------------
__fastcall TForm4::TForm4(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TForm4::FormHide(TObject *Sender)
{
	Form1->Show();
}
//---------------------------------------------------------------------------

void __fastcall TForm4::FormShow(TObject *Sender)
{
	Edit1->Visible = false;
	Edit2->Visible = false;
	Edit3->Visible = false;
	DateTimePicker1->Visible = false;
	DateTimePicker2->Visible = false;
	Panel1->Visible = false;
	Label1->Visible = false;
	Label2->Visible = false;
	Label3->Visible = false;
	Label4->Visible = false;
	Label5->Visible = false;
	ComboBox1->Visible = false;
	Edit4->Visible = false;
	Edit5->Visible = false;
	Label6->Visible = false;
	Label7->Visible = false;
	Label8->Visible = false;
	Panel2->Visible = false;
	Label9->Visible = false;
	Label10->Visible = false;
	ComboBox2->Visible = false;
	ComboBox3->Visible = false;
	Button1->Caption = "Добавить";
	switch (Form1->object) {
		case 1:
			Label1->Caption = "Тип самолета";
			Label2->Caption = "Количество мест";

			Label1->Visible = true;
			Label2->Visible = true;

			Edit1->Visible = true;
			Edit2->Visible = true;
		break;
		case 2:
			Label1->Caption = "Пункт отправления";
			Label2->Caption = "Пункт назначения";
			Label3->Caption = "Дата вылета";
			Label4->Caption = "Дата прилета";
			Label6->Caption = "Время вылета";
			Label7->Caption = "Время прилета";
			Label8->Caption = "Номер самолета";

			Label1->Visible = true;
			Label2->Visible = true;
			Label3->Visible = true;
			Label4->Visible = true;
			Label6->Visible = true;
			Label7->Visible = true;
			Label8->Visible = true;

			Edit1->Visible = true;
			Edit2->Visible = true;
			Edit4->Visible = true;
			Edit5->Visible = true;

			DateTimePicker1->Visible = true;
			DateTimePicker2->Visible = true;

			Form1->ADOQuery1->Active = false;
			Form1->ADOQuery1->SQL->Text =
			"SELECT Номер_самолета FROM Самолеты";
			Form1->ADOQuery1->Active = true;
			ComboBox1->Items->Clear();
			for (; !Form1->ADOQuery1->Eof; Form1->ADOQuery1->Next())
				ComboBox1->Items->Add\
				(Form1->ADOQuery1->FieldByName("Номер_самолета")->AsString);
			ComboBox1->Text = ComboBox1->Items->Strings[0];
			ComboBox1->Visible = true;
		break;
		case 3:
			Label1->Caption = "Имя";
			Label2->Caption = "Фамилия";
			Label3->Caption = "Отчество";
			Label4->Caption = "Дата рождения";
			Label6->Caption = "Серия паспорта";
			Label7->Caption = "Номер паспорта";

			Label1->Visible = true;
			Label2->Visible = true;
			Label3->Visible = true;
			Label4->Visible = true;
			Label5->Visible = true;
			Label6->Visible = true;
			Label7->Visible = true;

			Edit1->Visible = true;
			Edit2->Visible = true;
			Edit3->Visible = true;
			Edit4->Visible = true;
			Edit5->Visible = true;

			Panel1->Visible = true;

			DateTimePicker2->Visible = true;
		break;
		case 4:
			ticket_type = "econom";

			Label11->Caption = "Номер места";
			Label8->Caption = "Номер пассажира";
			Label9->Caption = "Номер рейса";

			Label11->Visible = true;
			Label8->Visible = true;
			Label9->Visible = true;
			Label10->Visible = true;

			ComboBox1->Visible = true;
			ComboBox2->Visible = true;
			ComboBox3->Visible = true;

			Panel2->Visible = true;

			Form1->ADOQuery1->Active = false;
			Form1->ADOQuery1->SQL->Text = "SELECT Номер_пассажира\
			FROM Пассажиры";
			Form1->ADOQuery1->Active = true;
			ComboBox1->Items->Clear();
			for (; !Form1->ADOQuery1->Eof; Form1->ADOQuery1->Next())
				ComboBox1->Items->Add\
				(Form1->ADOQuery1->FieldByName("Номер_пассажира")->AsString);
			ComboBox1->Text = ComboBox1->Items->Strings[0];

			Form1->ADOQuery1->Active = false;
			Form1->ADOQuery1->SQL->Text = "SELECT Номер_рейса FROM Рейсы";
			Form1->ADOQuery1->Active = true;
			ComboBox2->Items->Clear();
			for (; !Form1->ADOQuery1->Eof; Form1->ADOQuery1->Next())
				ComboBox2->Items->Add\
				(Form1->ADOQuery1->FieldByName("Номер_рейса")->AsString);
			ComboBox2->Text = ComboBox2->Items->Strings[0];
		break;
	}
}
//---------------------------------------------------------------------------
void __fastcall TForm4::ComboBox2Select(TObject *Sender)
{
	if (Form1->object == 4)
		n_s_box_refresh();
}
//---------------------------------------------------------------------------

void __fastcall TForm4::Button1Click(TObject *Sender)
{
	int n_pas, n_pl, n_fl, n_t, n_s = 0;
	switch (Form1->object) {
		case 1:

		break;
		case 2:
		break;
		case 3:
		break;
		case 4:
			Form1->ADOQuery1->Close();
			Form1->ADOQuery1->SQL->Clear();
			Form1->ADOQuery1->SQL->Add("SELECT MAX (Номер_билета) FROM Билеты"); // ticket number
			Form1->ADOQuery1->Open();

			if ((ComboBox1->Text.IsEmpty())||
			(ComboBox2->Text.IsEmpty())||(ComboBox3->Text.IsEmpty()))
				ShowMessage("Неа");
			else {
				n_t = Form1->ADOQuery1->Fields->Fields[0]->AsInteger + 1;
				n_pas = ComboBox1->Text.ToInt();
				n_fl = ComboBox2->Text.ToInt();
				n_s = ComboBox3->Text.ToInt();

				Form1->ADOQuery1->Close();
				Form1->ADOQuery1->SQL->Clear();
				Form1->ADOQuery1->SQL->Add(\
				"INSERT INTO Билеты\
				(Номер_билета, Тип_билета, Номер_места,\
				Номер_пассажира, Номер_рейса)\
				VALUES (" + IntToStr(n_t) + ",'"\
				+ ticket_type + "'," + IntToStr(n_s)\
				+ "," + n_pas + "," + n_fl + ")");
				Form1->ADOQuery1->ExecSQL();
				ShowMessage("Ага");
				n_s_box_refresh();
			}
		break;
	}
}
//---------------------------------------------------------------------------

void __fastcall TForm4::RadioButton5Click(TObject *Sender)
{
	ticket_type = "econom";
}
//---------------------------------------------------------------------------

void __fastcall TForm4::RadioButton4Click(TObject *Sender)
{
	ticket_type = "busine";
}
//---------------------------------------------------------------------------

void __fastcall TForm4::RadioButton3Click(TObject *Sender)
{
	ticket_type = "first";
}
//---------------------------------------------------------------------------

